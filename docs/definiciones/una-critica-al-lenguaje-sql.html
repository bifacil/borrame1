<!DOCTYPE html []>
<html lang="es" data-authenticationTime="1 ms" data-authorizeRequestTime="3 ms" data-engineCreationTime="19 ms" data-engineVariablesTime="1 ms" data-responseCreationTime="6" data-evaluationTime="12" data-queryTime="0" data-evaluationsCount="227" data-queryCount="1" data-query="definiciones/una-critica-al-lenguaje-sql.html">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1,requiresActiveX=true" />
    <title>Cada vez que repites código Dios mata un gatito (parte 1)</title>
    <meta name="description" content="Como sabrás, el desarrollo ETL suele representar el 70% del costo de los proyectos de Business Intelligence, y la excesiva  verbosidad del lenguaje SQL es la responsable de buena parte de esa complejidad. Merece la pena, por lo tanto, analizar el problema de este lenguaje." />
    <meta name="keywords" content="Business Intelligence,datawarehouse,crono,BI,cuadro de mando,Barcelona,España" />
    <meta name="y_key" content="f9df80cf3ef594d6" />
    <meta name="google-site-verification" content="w6gZESf_S3APOXfjzJMrnLIiA9bcWeRPJSTjlB-8Mfg" />
    <meta name="msvalfidate.01" content="401B0C3C6EEDE1AC271C85838378209E" />
    <link href="../resources/images/favicon.png" rel="shortcut icon" />
    <link href="../resources/js/animations/animate.min.css" rel="stylesheet" />
    <link href="../resources/css/fontawesome/font-awesome.min.css" rel="stylesheet" />
    <link href="../resources/css/iconfontcustom/icon-font-custom.css" rel="stylesheet" />
    <link href="../resources/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../resources/css/font-awesome.min.css" rel="stylesheet" />
    <link href="../resources/css/base.css" rel="stylesheet" />
    <link href="../resources/css/style.css" type="text/css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Ubuntu:100,100i,300,300i,400,400i,700" rel="stylesheet" />
    <link href="https://www.businessintelligence.info/rss.xml" rel="alternate" type="application/rss+xml" title="(RSS)" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Roboto&amp;display=swap" rel="stylesheet" />
    <link href="https://www.businessintelligence.info/definiciones/una-critica-al-lenguaje-sql.html" rel="canonical" />
    <script src="../resources/js/jquery-2.1.1.min.js"></script>
    <script src="../resources/js/viewport/jquery.viewport.js"></script>
    <script>
      (function() {
        var cx = '001840061174465826245:yxey5gkicrq';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
            '//cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
  </head>
  <body>
    <div id="wrap">
      <header id="header" class="stuck">
        <div class="row">
          <div class="span3">
            <div id="logo">
              <a href="../index.html">
                <img src="../resources/images/Logo-bif-crono.png" alt="" />
              </a>
            </div>
          </div>
          <div class="span9">
            <a href="#" id="mobile-menu-trigger">
              <i class="fa fa-bars"></i>
            </a>
            <nav>
              <ul class="sf-menu fixed" id="menu">
                <li>
                  <div class="buscador_google">
                    <div class="gcse-search"></div>
                  </div>
                </li>
                <li>
                  <a href="../index.html">Inicio</a>
                </li>
                <li>
                  <a href="../archivo.html">Archivo</a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </header>
      <div class="row" id="banner">
        <div class="span10 banner">
          <a href="https://businessintelligence.es" alt="Business Intelligence">
            <img src="../resources/images/banner1.jpg" />
          </a>
        </div>
      </div>
      <div class="row">
        <main class="span10 post">
          <article>
            <div>
              <div class="up-title">
                <h1>Cada vez que repites código Dios mata un gatito (parte 1)</h1>
                <a class="catlink" href="../categorias.html#definiciones">Definiciones</a>
              </div>
              <div class="fecha">lunes, 21 de enero de 2013</div>
              <p style="text-align:center">
                <img src="https://www.businessintelligence.info/resources/imagenes-bi/kitten-meme.png" alt="Cada vez que repites código, Dios mata un gatito" title="Cada vez que repites código, Dios mata un gatito" width="591" height="349" />
              </p>
              <h3>Una crítica al lenguaje SQL</h3>
              <p>
                <span>La semana pasada hablaba de </span>
                <a href="https://www.businessintelligence.info/definiciones/lo-mas-importante-para-crear-datawarehouse-dry.html">la importancia de la filosofía DRY en los proyectos de datawarehousing</a>
                <span> y mencionaba el SQL como ejemplo de lenguaje excesivamente  reiterativo.  Paradójicamente, el </span>
                <a href="http://es.wikipedia.org/wiki/Programaci%C3%B3n_declarativa">lenguaje declarativo</a>
                <span> por excelencia (SQL) contiene una serie de </span>
                <a href="http://en.wikipedia.org/wiki/Don't_repeat_yourself">defectos WET</a>
                <span> impensables en </span>
                <a href="http://es.wikipedia.org/wiki/Lenguaje_orientado_a_objetos">lenguajes OO</a>
                <span> (C#, Java, Phyton, etc.).
</span>
              </p>
              <p>Tras el galimatías de siglas del primer párrafo, la audiencia de este artículo habrá quedada mermada por lo menos a la mitad, por lo que si has leído hasta aquí ya te habrás dado cuenta que este artículo va dirigido a mis lectores más técnicos.  Si y solo si estás en este grupo, puedes seguir leyendo. Avisado estás.
</p>
              <p>
                <span>Como sabrás, </span>
                <b>el desarrollo ETL suele representar el 70% del costo de los proyectos de Business Intelligence</b>
                <span>, y la excesiva  verbosidad del lenguaje SQL es la responsable de buena parte de esa complejidad. Merece la pena, por lo tanto, analizar el problema de este lenguaje. Empezaré comentando las cosas más triviales e iré introduciendo el resto de “defectos WET” que provocan que el desarrollo y mantenimiento del código SQL sea penoso y hasta en ocasiones inasumible (¿De qué si no iban a existir las herramientas ETL?).
</span>
              </p>
              <h3>Ejemplos</h3>
              <p>Pongamos el caso de la base de datos de ejemplo que incluye SQL Server (AdventureWorksDW). Este es el modelo de datos de una de sus estrellas:
</p>
              <p style="text-align:center">
                <img src="https://www.businessintelligence.info/resources/imagenes-bi/ventas-adventure-wo.png" alt="Modelo de datos de una estrella de ventas del data warehouse de ejemplo de Adventure Works" title="Modelo de datos de una estrella de ventas del data warehouse de ejemplo de Adventure Works" width="567" height="571" />
              </p>
              <p>Veamos cómo serían algunas consultas contra este modelo.
</p>
              <p>Por ejemplo, si me piden “el detalle de las bicicletas vendidas en enero de 2008, ordenadas en función de su precio” tengo que escribir esta consulta SQL:
</p>
              <pre>
                <code>-- Ejemplo 1

SELECT
  DimProduct.EnglishProductName AS Producto,
  sum(sales.OrderQuantity) AS Unidades,
  sum(sales.SalesAmount) AS Importe,
  sum(sales.SalesAmount)/sum(sales.OrderQuantity) AS [Precio Medio]
FROM FactResellerSales sales
INNER JOIN DimProduct ON (sales.ProductKey=DimProduct.ProductKey)
INNER JOIN DimProductSubCategory ON (DimProduct.ProductSubcategoryKey=DimProductSubCategory.ProductSubcategoryKey)
INNER JOIN DimProductCategory ON (DimProductSubCategory.ProductCategoryKey=DimProductCategory.ProductCategoryKey)
INNER JOIN DimDate ON (sales.OrderDateKey=DimDate.DateKey)
WHERE
  DimProductCategory.SpanishProductCategoryName='Bicicleta'
  AND DimDate.SpanishMonthName='Enero'
  AND DimDate.CalendarYear=2008
GROUP BY DimProduct.EnglishProductName
ORDER BY sum(sales.SalesAmount)/sum(sales.OrderQuantity) DESC


</code>
              </pre>
              <p>A simple vista, ya se detectan algunas reiteraciones “innecesarias”:
</p>
              <ul>
                <li>
                  <b>El GROUP BY</b>
                  <span>. ¿Por qué hemos de poner siempre el </span>
                  <i>GROUP BY</i>
                  <span>? En un porcentaje altísimo de las ocasiones, las columnas </span>
                  <i>GROUP BY</i>
                  <span> son fácilmente deducibles de las columnas de la cláusula </span>
                  <i>SELECT (…s</i>
                  <span>e ha de agrupar por todas las columnas salvo aquellas que son funciones de agregación tipo sum, </span>
                  <i>max</i>
                  <span>,</span>
                  <i>min</i>
                  <span> y </span>
                  <i>avg</i>
                  <span>).
</span>
                </li>
                <li>
                  <b>Las fórmulas. </b>
                  <span>En el ejemplo anterior, la fórmula </span>
                  <i>sum(sales.OrderQuantity)</i>
                  <span> se repite hasta 3 veces (en la columna “Unidades”, en la columna “Precio”, y en la cláusula </span>
                  <i>ORDER BY</i>
                  <span>).  También se repiten “innecesariamente” las fórmulas de importe y precios. 
</span>
                </li>
              </ul>
              <p>
                <span>Sé que las cosas anteriores pueden parecer triviales pero, como dije el otro día, hemos de cuestionar cualquier incumplimiento de la máxima DRY. En casos reales, el </span>
                <i>GROUP BY</i>
                <span> puede tener muchas columnas, y las fórmulas pueden complicarse con </span>
                <i>CASE</i>
                <span> y otros artificios diabólicos. Además, estos defectos del lenguaje se acumulan: Imagínate una fórmula complicada en el SELECT, que se reutiliza en otra columna del SELECT, y que se agrupa en el GROUP BY, se filtra en el WHERE, y se ordena en el ORDER BY…)…
</span>
              </p>
              <p>
                <span>Si no te he convencido, aún, vuelve a mirar la imagen que encabeza este artículo y, por favor, piensa en los gatitos. Pero por lo que más quieras,  </span>
                <b>¡No repitas código!</b>
                <span></span>
              </p>
              <p>Además de estos 2 defectos WET, existe otro  menos evidente. Veamos otros ejemplos para descubrirlo:
</p>
              <p>Si me piden “las bicicletas vendidas en Alemania durante el 2008” haré esta consulta:
</p>
              <pre>
                <code>-- Ejemplo 2

SELECT
  DimProduct.EnglishProductName AS EnglishProductName,
  sum(sales.OrderQuantity) AS Unidades
FROM FactResellerSales sales
INNER JOIN DimReseller ON (sales.ResellerKey=DimReseller.ResellerKey)
INNER JOIN DimGeography ON (DimReseller.GeographyKey=DimGeography.GeographyKey)
INNER JOIN DimProduct ON (sales.ProductKey=DimProduct.ProductKey)
INNER JOIN DimProductSubCategory ON (DimProduct.ProductSubcategoryKey=DimProductSubCategory.ProductSubcategoryKey)
INNER JOIN DimProductCategory ON (DimProductSubCategory.ProductCategoryKey=DimProductCategory.ProductCategoryKey)
INNER JOIN DimDate ON (sales.OrderDateKey=DimDate.DateKey)
WHERE
  DimGeography.SpanishCountryRegionName='Alemania'
  AND DimProductCategory.SpanishProductCategoryName='Bicicleta'
  AND DimDate.CalendarYear=2008
GROUP BY DimProduct.EnglishProductName

</code>
              </pre>
              <p>O si me piden “el total de unidades vendidas en 2008 por países” haré esta consulta:
</p>
              <pre>
                <code>--Ejemplo 3

SELECT
  DimGeography.SpanishCountryRegionName AS SpanishCountryRegionName,
  sum(sales.OrderQuantity) AS Unidades
FROM FactResellerSales sales
INNER JOIN DimReseller ON (sales.ResellerKey=DimReseller.ResellerKey)
INNER JOIN DimGeography ON (DimReseller.GeographyKey=DimGeography.GeographyKey)
INNER JOIN DimDate ON (sales.OrderDateKey=DimDate.DateKey)
WHERE DimDate.CalendarYear=2008
GROUP BY DimGeography.SpanishCountryRegionName

</code>
              </pre>
              <p>¿Ves ya lo que estamos repitiendo consulta tras consulta? Efectivamente:
</p>
              <ul>
                <li>
                  <b>Los JOINS</b>
                  <span>. Desde que he puesto la imagen del modelo de datos, todos sabíamos ya como relacionar las tablas. Prácticamente siempre las relaciones es algo propio del modelo de datos, es estático,  y es independiente de la consulta que quiera hacer el usuario. Puedo querer una información u otra, pero los JOINS son los que son, ¿Por qué los he de reescribir en cada ocasión? Además, si por cualquier motivo cambia el modelo de datos, deberemos retocar, reescribir, y reverificar cada una de las dos consultas. ¿Aún no ves el daño que hacen estos defectos WET en el código SQL que escribimos?
</span>
                </li>
              </ul>
              <h3>Operaciones entre filas con SQL</h3>
              <p>
                <span>Para finalizar por hoy comentaré el primero de los problemas no triviales. Se dice que con  SQL es muy sencillo hacer operaciones entre las columnas (como calcular el precio medio, por ejemplo), pero que es muy complicado hacer operaciones entre filas (como comparar las ventas respecto al año anterior).  En realidad, no es nada complicado, simplemente es un </span>
                <span style="text-decoration: line-through">coñazo </span>
                <span>poco entretenido.
</span>
              </p>
              <p>Por ejemplo, si me piden “el detalle de las bicicletas vendidas en enero de 2008 y en enero del 2007”, haré una consulta similar a ésta:
</p>
              <pre>
                <code>-- Ejemplo 4

WITH
sales1 AS (
  SELECT
    DimProduct.EnglishProductName AS EnglishProductName,
    sum(sales.OrderQuantity) AS auxcol_2_
  FROM FactResellerSales sales
  INNER JOIN DimProduct ON (sales.ProductKey=DimProduct.ProductKey)
  INNER JOIN DimProductSubCategory ON (DimProduct.ProductSubcategoryKey=DimProductSubCategory.ProductSubcategoryKey)
  INNER JOIN DimProductCategory ON (DimProductSubCategory.ProductCategoryKey=DimProductCategory.ProductCategoryKey)
  INNER JOIN DimDate ON (sales.OrderDateKey=DimDate.DateKey)
  WHERE
    DimDate.CalendarYear=2007
    AND DimProductCategory.SpanishProductCategoryName='Bicicleta'
    AND DimDate.SpanishMonthName='Enero'
  GROUP BY DimProduct.EnglishProductName
),
sales2 AS (
  SELECT
    DimProduct.EnglishProductName AS EnglishProductName,
    sum(sales.OrderQuantity) AS auxcol_3_
  FROM FactResellerSales sales
  INNER JOIN DimProduct ON (sales.ProductKey=DimProduct.ProductKey)
  INNER JOIN DimProductSubCategory ON (DimProduct.ProductSubcategoryKey=DimProductSubCategory.ProductSubcategoryKey)
  INNER JOIN DimProductCategory ON (DimProductSubCategory.ProductCategoryKey=DimProductCategory.ProductCategoryKey)
  INNER JOIN DimDate ON (sales.OrderDateKey=DimDate.DateKey)
  WHERE
    DimDate.CalendarYear=2008
    AND DimProductCategory.SpanishProductCategoryName='Bicicleta'
    AND DimDate.SpanishMonthName='Enero'
  GROUP BY DimProduct.EnglishProductName
),
COMUN AS (
  SELECT DISTINCT EnglishProductName FROM sales1
  UNION SELECT DISTINCT EnglishProductName FROM sales2
)
SELECT
  COMUN.EnglishProductName,
  sales1.auxcol_2_ AS [Ventas Enero 2007],
  sales2.auxcol_3_ AS [Ventas Enero 2008]
FROM COMUN
LEFT JOIN sales1 ON COMUN.EnglishProductName=sales1.EnglishProductName
LEFT JOIN sales2 ON COMUN.EnglishProductName=sales2.EnglishProductName




</code>
              </pre>
              <p>A pesar de la verbosidad del código anterior, la consulta se ejecuta perfectamente y escala linealmente (consultar 2 meses de este modo cuesta el doble que consultar un solo mes, lógicamente). El único problema del código es que repite todo innumerables veces: Los GROUP BYs, los WHEREs, los JOINs …  Lo cual confirma que el ANSI SQL es tediosamente verboso y afecta gravemente a la mantenibilidad del código generado…
</p>
              <p>QED.
</p>
              <p>
                <strong>ACTUALIZACIÓN:</strong> Os dejo a continuación el enlace a todos los artículos de esta serie con final sorprendente.</p>
              <ul>
                <li>
                  <a href="https://www.businessintelligence.info/definiciones/una-critica-al-lenguaje-sql.html">Artículo 1: Cada vez que repites código Dios mata un gatito</a>
                </li>
                <li>
                  <a href="https://www.businessintelligence.info/definiciones/una-critica-al-lenguaje-sql-ii.html">Artículo 2: Una crítica al lenguaje SQL</a>
                </li>
                <li>
                  <a href="https://www.businessintelligence.info/definiciones/una-critica-al-lenguaje-sql-reloaded.html">Artículo 3: Una crítica al lenguaje SQL</a>
                </li>
                <li>
                  <a href="https://www.businessintelligence.info/crono/presentacion-crono-sql.html">Artículo 4: Un SQL con superpoderes</a>
                </li>
                <li>
                  <a href="https://www.businessintelligence.info/crono/sql-dry-dont-repeat-yourself.html">Artículo 5: SQL sin repeticiones</a>
                </li>
              </ul>
            </div>
            <div class="comentarios">
              <div id="disqus_thread"></div>
              <script>
            		var disqus_config = function () {
            			this.page.url = 'https://www.businessintelligence.info/definiciones/una-critica-al-lenguaje-sql.html'
            			this.page.identifier = 'bifacil322'
            		};	
            		(function() { 
            			var d = document, s = d.createElement('script');
            			s.src = '//bifacil.disqus.com/embed.js';
            			s.setAttribute('data-timestamp', +new Date());
            			(d.head || d.body).appendChild(s);
            		})();
            	</script>
            </div>
          </article>
        </main>
      </div>
    </div>
    <footer>
      <div class="row">
        <div class="span3">
          <ul>
            <li>
              <a href="../index.html">Inicio</a>
            </li>
            <li>
              <a href="../archivo.html">Archivo</a>
            </li>
            <li>
              <a href="../categorias.html">Categorías</a>
            </li>
            <li>
              <a href="../sobre-el-blog/contacto.html">Contacto</a>
            </li>
            <li>
              <a href="../sobre-el-blog/enlaces.html">Enlaces</a>
            </li>
          </ul>
        </div>
        <div class="span3">
          <div class="rrss-footer">
            <a href="https://www.linkedin.com/company/businessintelligence" target="_blank" class="fa fa-linkedin"></a>
            <a href="http://twitter.com/bifacil" target="_blank" class="fa fa-twitter"></a>
            <a href="https://www.youtube.com/c/BusinessIntelligenceInfo" target="_blank" class="fa fa-youtube"></a>
            <a href="https://www.facebook.com/CronoBusinessIntelligence" target="_blank" class="fa fa-facebook"></a>
          </div>
        </div>
        <div class="span3">
          <section class="newsletter">
            <p>¿Quieres recibir los artículos de este blog por correo electrónico? No te pierdas ni un artículo. Mantente informado sobre lo que ocurre en el mundo del Business Intelligence. 
<a href="../subscribe.html">¡Síguenos!</a></p>
          </section>
        </div>
      </div>
    </footer>
    <script src="../resources/js/scripts.js"></script>
    <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      try {
        var pageTracker = _gat._getTracker("UA-3456231-2");
        pageTracker._trackPageview();
      } catch(err) {}
    </script>
  </body>
</html>